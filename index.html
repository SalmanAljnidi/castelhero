<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø©</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3069/3069172.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#2c3e50;--secondary:#34495e;--accent-correct:#2ecc71;--accent-wrong:#e74c3c;--gold:#f1c40f}
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{margin:0;padding:0;font-family:'Cairo',sans-serif;background-color:var(--primary);height:100vh;height:100dvh;overflow:hidden;touch-action:manipulation;user-select:none}
        .screen{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;color:white;text-align:center;padding:20px}
        .hidden{display:none!important}
        h1{font-size:2rem;margin:0 0 20px 0;color:var(--gold);text-shadow:3px 3px 0 rgba(0,0,0,0.5);font-weight:800}
        .credits-box{background:rgba(0,0,0,0.4);padding:10px;border-radius:15px;margin-bottom:10px;width:90%;max-width:400px;border:1px solid rgba(255,255,255,0.1)}
        .social-icons{display:flex;justify-content:center;gap:20px;margin-top:5px}
        .social-icons a{color:white;font-size:1.8rem;transition:transform 0.2s}
        .btn{background:linear-gradient(to bottom,#2ecc71,#27ae60);color:white;border:none;padding:12px 25px;font-size:1.2rem;border-radius:50px;margin:8px;cursor:pointer;font-family:'Cairo';box-shadow:0 5px 0 #1e8449;width:85%;max-width:300px;font-weight:bold}
        .btn:active{transform:translateY(5px);box-shadow:none}
        .btn-gold{background:linear-gradient(to bottom,#f1c40f,#f39c12);color:var(--primary);box-shadow:0 5px 0 #d35400}
        .btn-blue{background:#3498db;box-shadow:0 5px 0 #2980b9}
        /* Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª - ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
        .btn-install{background:#9b59b6;box-shadow:0 5px 0 #8e44ad;display:block} 
        
        .footer-credits{position:absolute;bottom:15px;width:100%;text-align:center;font-size:0.9rem;color:#ccc}
        .mode-select{display:flex;gap:10px;margin-bottom:15px;width:90%;max-width:400px}
        .mode-btn{flex:1;padding:10px;opacity:0.7;border:2px solid rgba(255,255,255,0.2);color:white;background:rgba(0,0,0,0.2);border-radius:10px;cursor:pointer;font-family:'Cairo'}
        .mode-btn.active{opacity:1;border-color:var(--gold);background:rgba(241,196,15,0.2);transform:scale(1.05);font-weight:bold}
        #game-view{flex:1;position:relative;background:linear-gradient(to bottom,#3498db,#87CEEB);overflow:hidden}
        canvas{width:100%;height:100%;display:block}
        #hud{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;color:white;pointer-events:none;z-index:20;font-size:1.2rem}
        .hud-group{display:flex;gap:15px;background:rgba(0,0,0,0.4);padding:5px 15px;border-radius:20px}
        #game-container{display:flex;flex-direction:column;height:100%}
        #controls-area{height:auto;min-height:35vh;background:var(--secondary);padding:15px;display:flex;flex-direction:column;gap:10px;border-top:6px solid var(--primary);z-index:10}
        #question-box{background:#fff;color:var(--primary);padding:10px;border-radius:15px;text-align:center;font-size:2rem;font-weight:800;min-height:80px;display:flex;flex-direction:column;justify-content:center}
        .visual-representation{display:flex;justify-content:center;gap:5px;margin-top:5px;flex-wrap:wrap}
        .dot{width:16px;height:16px;background:var(--accent-wrong);border-radius:50%;display:inline-block;box-shadow:inset -2px -2px rgba(0,0,0,0.2);border:1px solid rgba(0,0,0,0.1);position:relative}
        .dot.crossed{background:#bdc3c7;opacity:0.6}
        .dot.crossed::after,.dot.crossed::before{content:'';position:absolute;top:50%;left:50%;width:100%;height:3px;background:#c0392b}
        .dot.crossed::after{transform:translate(-50%,-50%) rotate(45deg)} .dot.crossed::before{transform:translate(-50%,-50%) rotate(-45deg)}
        #options-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;height:90px}
        .option-btn{background:#ecf0f1;color:var(--primary);border:none;font-size:1.8rem;font-weight:bold;border-radius:15px;cursor:pointer;box-shadow:0 6px 0 #bdc3c7;font-family:'Cairo';height:100%}
        .option-btn:active{transform:translateY(6px);box-shadow:none}
        .shake{animation:shake 0.4s cubic-bezier(.36,.07,.19,.97) both}
        @keyframes shake{10%,90%{transform:translate3d(-2px,0,0)}20%,80%{transform:translate3d(4px,0,0)}30%,50%,70%{transform:translate3d(-6px,0,0)}40%,60%{transform:translate3d(6px,0,0)}}
        .shop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:15px 0}
        .shop-item{background:rgba(255,255,255,0.1);padding:10px;border-radius:10px;border:2px solid transparent;cursor:pointer}
        .shop-item.selected{border-color:var(--gold);background:rgba(241,196,15,0.2)}
        .shop-item.locked{opacity:0.5;filter:grayscale(1)}
        .shop-icon{font-size:2.5rem}
    </style>
</head>
<body>
    <div id="start-screen" class="screen">
        <h1 style="margin-top:40px">Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</h1>
        
        <p style="margin:5px;color:#ecf0f1">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</p>
        <div class="mode-select">
            <button id="mode-lower" class="mode-btn active" onclick="setMode('lower')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</button>
            <button id="mode-upper" class="mode-btn" onclick="setMode('upper')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ù„ÙŠØ§</button>
        </div>
        
        <button class="btn" onclick="initAudioAndStart()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ! âš”ï¸</button>
        <button class="btn btn-gold" onclick="showShop()">Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’</button>
        
        <button id="install-btn" class="btn btn-install" onclick="installApp()">
            <i class="fas fa-download"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø©
        </button>

        <div class="footer-credits">
            <div class="credits-name">ÙÙƒØ±Ø© ÙˆØªØµÙ…ÙŠÙ…: Ø£. Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</div>
            <div class="social-icons">
                <a href="https://wa.me/966566996166" target="_blank"><i class="fab fa-whatsapp"></i></a>
                <a href="https://snapchat.com/t/2tVDWcXq" target="_blank"><i class="fab fa-snapchat"></i></a>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="screen hidden">
        <h2 style="color:var(--gold)">Ø§Ø®ØªØ± Ø¨Ø·Ù„Ùƒ</h2>
        <p>Ø±ØµÙŠØ¯Ùƒ: <span class="arabic-num" id="shop-coins-disp">Ù </span> ğŸ’°</p>
        <div class="shop-grid" id="shop-items-container"></div>
        <button class="btn btn-blue" onclick="closeShop()">Ø¹ÙˆØ¯Ø©</button>
    </div>
    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: var(--accent-wrong);">Ø³Ù‚Ø·Øª Ø§Ù„Ù‚Ù„Ø¹Ø©!</h1>
        <p style="font-size: 1.5rem;">Ø¬Ù…Ø¹Øª: <span class="arabic-num" id="final-score">Ù </span> Ù†Ù‚Ø·Ø©</p>
        <button class="btn" onclick="resetGame()">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        <button class="btn btn-blue" onclick="location.reload()">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
    <div id="game-container" class="hidden">
        <div id="game-view">
            <canvas id="game-canvas"></canvas>
            <div id="hud">
                <div class="hud-group">
                    <div><i class="fas fa-heart" style="color:#e74c3c"></i> <span class="arabic-num" id="lives-disp">Ù£</span></div>
                    <div><i class="fas fa-star" style="color:var(--gold)"></i> <span class="arabic-num" id="score-disp">Ù </span></div>
                </div>
            </div>
        </div>
        <div id="controls-area">
            <div id="question-box"><div id="q-text">...</div><div id="q-visual"></div></div>
            <div id="options-grid">
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
            </div>
        </div>
    </div>

    <script>
        // --- ÙƒÙˆØ¯ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø¶Ù…ÙˆÙ† ---
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js'); }); }
        
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => { deferredPrompt = null; });
            } else {
                // ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙŠØ¯ÙˆÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¹Ø±Ù Ø§Ù„Ù…ØªØµÙØ­
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) alert("Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠÙÙˆÙ†:\n1. Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ø³Ù‡Ù… Ù„Ù„Ø£Ø¹Ù„Ù‰) â¬†ï¸\n2. Ø§Ø®ØªØ± 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' ğŸ“±");
                else alert("Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø©:\nØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ (Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·) â\nØ«Ù… Ø§Ø®ØªØ± 'ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚' Ø£Ùˆ 'Add to Home Screen' ğŸ“²");
            }
        }

        // --- Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        let audioCtx; function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
        function playSound(t) { if(!audioCtx)return; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); if(t==='correct'){o.type='sine';o.frequency.setValueAtTime(500,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(1000,audioCtx.currentTime+0.1);g.gain.setValueAtTime(0.3,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);o.start();o.stop(audioCtx.currentTime+0.3);}else{o.type='sawtooth';o.frequency.setValueAtTime(150,audioCtx.currentTime);g.gain.setValueAtTime(0.3,audioCtx.currentTime);g.gain.linearRampToValueAtTime(0.01,audioCtx.currentTime+0.3);o.start();o.stop(audioCtx.currentTime+0.3);} }

        const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d');
        let gameMode='lower', score=0, lives=3, coins=0, currentAnswer=0, gameState='start', difficulty=1;
        let savedData = JSON.parse(localStorage.getItem('mathHero_v14')) || {coins:0, boughtSkins:['ğŸ¤´'], currentSkin:'ğŸ¤´'};
        coins=savedData.coins;
        const shopItems = [{icon:'ğŸ¤´',price:0},{icon:'ğŸ¦¸â€â™‚ï¸',price:50},{icon:'ğŸ¥·',price:100},{icon:'ğŸ§™â€â™‚ï¸',price:200},{icon:'ğŸ¤–',price:300},{icon:'ğŸ§”',price:500}];
        let hero={x:50,y:0,sprite:savedData.currentSkin}, enemies=[], particles=[], clouds=[], groundLevel=0, castleX=0;

        function toArabicNum(n){return n.toString().replace(/\d/g,d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);}
        function resizeCanvas(){ const c=document.getElementById('game-view'); if(c){canvas.width=c.clientWidth; canvas.height=c.clientHeight; groundLevel=canvas.height*0.75; hero.y=groundLevel+5; castleX=canvas.width*0.25; enemies.forEach(e=>e.y=groundLevel+5);} }
        window.addEventListener('resize', resizeCanvas);
        function initClouds(){clouds=[];for(let i=0;i<5;i++)clouds.push({x:Math.random()*canvas.width,y:Math.random()*(canvas.height/2),speed:0.1+Math.random()*0.2,size:30+Math.random()*40});}
        
        function drawEnvironment(){
            ctx.fillStyle='#f1c40f'; ctx.beginPath();ctx.arc(canvas.width-50,50,30,0,Math.PI*2);ctx.fill();
            ctx.fillStyle='rgba(255,255,255,0.7)'; clouds.forEach(c=>{c.x-=c.speed;if(c.x<-100)c.x=canvas.width+100;ctx.beginPath();ctx.arc(c.x,c.y,c.size,0,Math.PI*2);ctx.arc(c.x+c.size*0.5,c.y-c.size*0.5,c.size*0.8,0,Math.PI*2);ctx.arc(c.x+c.size,c.y,c.size*0.9,0,Math.PI*2);ctx.fill();});
            ctx.fillStyle='#27ae60';ctx.fillRect(0,groundLevel,canvas.width,canvas.height-groundLevel);
            ctx.fillStyle='#2ecc71';ctx.fillRect(0,groundLevel,canvas.width,10);
            ctx.strokeStyle='#bdc3c7';ctx.lineWidth=4;ctx.setLineDash([10,5]);ctx.beginPath();ctx.moveTo(castleX+30,groundLevel);ctx.lineTo(castleX+30,groundLevel-150);ctx.stroke();ctx.setLineDash([]);
            drawCastle();
        }
        function drawCastle(){
            const w=Math.min(canvas.width*0.25,120), h=canvas.height*0.45, x=10, base=groundLevel;
            ctx.fillStyle='rgba(0,0,0,0.2)';ctx.beginPath();ctx.ellipse(x+w/2,base,w/2,10,0,0,Math.PI*2);ctx.fill();
            ctx.fillStyle='#7f8c8d';ctx.fillRect(x,base-h+30,w,h-30);
            ctx.fillStyle='#34495e';ctx.fillRect(x-5,base-h+20,w+10,15);
            ctx.fillStyle='#4e342e';ctx.beginPath();ctx.arc(x+w/2,base,w/3,Math.PI,0);ctx.fill();
            ctx.strokeStyle='#fff';ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(x+w/2,base-h);ctx.lineTo(x+w/2,base-h-40);ctx.stroke();
            ctx.fillStyle='#e74c3c';ctx.beginPath();ctx.moveTo(x+w/2,base-h-40);ctx.lineTo(x+w+20,base-h-30);ctx.lineTo(x+w/2,base-h-20);ctx.fill();
        }

        function initAudioAndStart(){ initAudio(); startGame(); }
        function startGame(){ gameState='playing'; score=0; lives=3; difficulty=1; enemies=[]; particles=[]; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('game-container').classList.remove('hidden'); resizeCanvas(); initClouds(); updateHUD(); generateNewQuestion(); gameLoop(0); }
        function updateHUD(){ document.getElementById('lives-disp').innerText=toArabicNum(lives); document.getElementById('score-disp').innerText=toArabicNum(score); document.getElementById('shop-coins-disp').innerText=toArabicNum(coins); document.getElementById('final-score').innerText=toArabicNum(score); localStorage.setItem('mathHero_v14',JSON.stringify({coins,boughtSkins:savedData.boughtSkins,currentSkin:savedData.currentSkin})); }

        function generateNewQuestion(){
            let n1,n2,vis='';
            if(gameMode==='lower'){
                if(Math.random()>0.5){ n1=Math.floor(Math.random()*6); n2=Math.floor(Math.random()*(11-n1)); currentAnswer=n1+n2; document.getElementById('q-text').innerText=`${toArabicNum(n1)} + ${toArabicNum(n2)} = ØŸ`; vis=drawDots(n1,false)+'<span style="font-size:1.5rem">+</span>'+drawDots(n2,false); }
                else { n1=Math.floor(Math.random()*11); n2=Math.floor(Math.random()*(n1+1)); currentAnswer=n1-n2; document.getElementById('q-text').innerText=`${toArabicNum(n1)} âˆ’ ${toArabicNum(n2)} = ØŸ`; vis=drawSub(n1,n2); }
            } else {
                if(Math.random()>0.5){ n1=Math.floor(Math.random()*11); n2=Math.floor(Math.random()*11); currentAnswer=n1*n2; document.getElementById('q-text').innerText=`${toArabicNum(n1)} Ã— ${toArabicNum(n2)} = ØŸ`; }
                else { n2=Math.floor(Math.random()*9)+1; currentAnswer=Math.floor(Math.random()*11); n1=n2*currentAnswer; document.getElementById('q-text').innerText=`${toArabicNum(n1)} Ã· ${toArabicNum(n2)} = ØŸ`; }
            }
            document.getElementById('q-visual').innerHTML=vis;
            let opts=[currentAnswer]; while(opts.length<3){let r=currentAnswer+(Math.random()>0.5?1:-1)*(Math.floor(Math.random()*5)+1); if(r>=0&&!opts.includes(r))opts.push(r);} opts.sort(()=>Math.random()-0.5);
            document.querySelectorAll('.option-btn').forEach((b,i)=>{ b.innerText=toArabicNum(opts[i]); b.setAttribute('data-val',opts[i]); b.disabled=false; b.style.backgroundColor='#ecf0f1'; b.style.color='var(--primary)'; b.style.transform='scale(1)'; });
        }
        function drawDots(n){if(gameMode==='upper')return'';let s='';for(let i=0;i<n;i++)s+='<span class="dot"></span>';return `<div class="visual-representation">${s}</div>`;}
        function drawSub(t,c){if(gameMode==='upper')return'';let s='';for(let i=0;i<t;i++){s+=`<span class="dot ${i>=(t-c)?'crossed':''}"></span>`;}return `<div class="visual-representation">${s}</div>`;}

        function checkAnswer(btn){
            try{
                let val=parseInt(btn.getAttribute('data-val')); const all=document.querySelectorAll('.option-btn'); if(btn.disabled)return; all.forEach(b=>b.disabled=true);
                if(val===currentAnswer){
                    btn.style.backgroundColor='#2ecc71'; btn.style.color='white'; btn.style.transform='scale(1.1)'; playSound('correct'); score+=10; coins+=2;
                    let px=canvas.width*0.15, py=groundLevel-30; ctx.fillStyle='orange'; ctx.beginPath();ctx.arc(px,py,10,0,Math.PI*2);ctx.fill();
                    setTimeout(()=>{if(enemies.length>0){createExp(enemies[0].x,enemies[0].y);enemies.shift();playSound('wrong');}},200);
                    updateHUD(); setTimeout(generateNewQuestion,800);
                } else {
                    btn.style.backgroundColor='#e74c3c'; btn.style.color='white'; playSound('wrong');
                    document.getElementById('controls-area').classList.add('shake'); setTimeout(()=>{document.getElementById('controls-area').classList.remove('shake'); all.forEach(b=>{b.disabled=false;b.style.backgroundColor='#ecf0f1';b.style.color='var(--primary)';b.style.transform='scale(1)';});},500);
                }
            }catch(e){}
        }

        function gameLoop(t){
            if(gameState!=='playing')return;
            ctx.clearRect(0,0,canvas.width,canvas.height); drawEnvironment();
            ctx.font=`${canvas.height*0.15}px Cairo`; ctx.textAlign='center'; ctx.fillText(hero.sprite,canvas.width*0.15,groundLevel+5);
            if(enemies.length===0){ enemies.push({x:canvas.width+50,y:groundLevel+5,speed:1.5*difficulty,sprite:['ğŸ‘¾','ğŸ‘º','ğŸ‘¹','ğŸ‰','ğŸ¦–'][Math.floor(Math.random()*5)],walkOffset:0,attackTimer:0,maxAttackTime:900}); }
            else if(enemies.length<2){ if(enemies[enemies.length-1].x < canvas.width-250) enemies.push({x:canvas.width+50,y:groundLevel+5,speed:1.5*difficulty,sprite:['ğŸ‘¾','ğŸ‘º','ğŸ‘¹','ğŸ‰','ğŸ¦–'][Math.floor(Math.random()*5)],walkOffset:0,attackTimer:0,maxAttackTime:900}); }
            for(let i=0;i<enemies.length;i++){
                let e=enemies[i], stop=castleX+40+(i*70);
                if(e.x>stop){ e.x-=e.speed; e.walkOffset+=0.15; ctx.font=`${canvas.height*0.12}px Cairo`; ctx.fillText(e.sprite,e.x,e.y+Math.sin(e.walkOffset)*5); }
                else {
                    e.x=stop; ctx.font=`${canvas.height*0.12}px Cairo`; ctx.fillText(e.sprite,e.x,e.y);
                    if(i===0){
                        e.attackTimer++; let p=e.attackTimer/e.maxAttackTime;
                        ctx.fillStyle="#555"; ctx.fillRect(e.x-30,e.y-70,60,8); ctx.fillStyle=p>0.7?"#e74c3c":"#2ecc71"; ctx.fillRect(e.x-30,e.y-70,60*(1-p),8);
                        if(e.attackTimer>=e.maxAttackTime){ lives--; updateHUD(); playSound('wrong'); document.getElementById('game-view').classList.add('shake'); setTimeout(()=>document.getElementById('game-view').classList.remove('shake'),400); createExp(e.x,e.y); enemies.shift(); i--; if(lives<=0){gameState='over';document.getElementById('game-container').classList.add('hidden');document.getElementById('game-over-screen').classList.remove('hidden');} }
                    } else { ctx.font="20px Arial"; ctx.fillStyle="#fff"; ctx.fillText("â³",e.x,e.y-60); }
                }
            }
            for(let i=particles.length-1;i>=0;i--){let p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life-=0.04;ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();if(p.life<=0)particles.splice(i,1);}
            ctx.globalAlpha=1; requestAnimationFrame(gameLoop);
        }
        function createExp(x,y){for(let i=0;i<25;i++)particles.push({x:x,y:y-20,vx:(Math.random()-0.5)*15,vy:(Math.random()-0.5)*15,life:1,size:Math.random()*8+2,color:`hsl(${Math.random()*60+10},100%,50%)`});}
        
        function renderShop(){const c=document.getElementById('shop-items-container');c.innerHTML='';shopItems.forEach(i=>{let o=savedData.boughtSkins.includes(i.icon);let d=document.createElement('div');d.className=`shop-item ${savedData.currentSkin===i.icon?'selected':''} ${!o?'locked':''}`;d.innerHTML=`<div class="shop-icon">${i.icon}</div><div>${o?'âœ”':toArabicNum(i.price)}</div>`;d.onclick=()=>{if(o){savedData.currentSkin=i.icon;hero.sprite=i.icon;renderShop();updateHUD();}else if(coins>=i.price){coins-=i.price;savedData.boughtSkins.push(i.icon);savedData.currentSkin=i.icon;hero.sprite=i.icon;playSound('correct');renderShop();updateHUD();}};c.appendChild(d);});}
        function showShop(){document.getElementById('start-screen').classList.add('hidden');document.getElementById('shop-screen').classList.remove('hidden');renderShop();}
        function closeShop(){document.getElementById('shop-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}
        function setMode(m){gameMode=m;document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));document.getElementById('mode-'+m).classList.add('active');}
        function resetGame(){document.getElementById('game-over-screen').classList.add('hidden');startGame();}
    </script>
</body>
</html>
