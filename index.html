<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© | Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" id="manifest-placeholder">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent-correct: #2ecc71;
            --accent-wrong: #e74c3c;
            --gold: #f1c40f;
            --bg-sky-top: #3498db;
            --bg-sky-bot: #87CEEB;
            --bg-ground: #27ae60;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Cairo', sans-serif;
            background-color: var(--primary);
            height: 100vh; height: 100dvh;
            overflow: hidden; touch-action: manipulation; user-select: none;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; color: white; text-align: center; padding: 20px;
        }
        .hidden { display: none !important; }

        h1 {
            font-size: 2rem; margin: 0 0 10px 0; color: var(--gold);
            text-shadow: 3px 3px 0 rgba(0,0,0,0.5); font-weight: 800;
        }
        
        .credits-box {
            background: rgba(0,0,0,0.4); padding: 15px; border-radius: 15px;
            margin-bottom: 20px; width: 90%; max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        .credits-name { font-size: 1.1rem; margin-bottom: 10px; color: #ecf0f1; font-weight: bold; }
        .social-icons { display: flex; justify-content: center; gap: 25px; }
        .social-icons a {
            color: white; font-size: 2.2rem; text-decoration: none;
            transition: transform 0.2s; display: inline-block;
        }
        .social-icons a:hover { transform: scale(1.2); }
        .fa-whatsapp { color: #25D366; }
        .fa-snapchat { color: #FFFC00; text-shadow: 0 0 5px #000; }

        .btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60); color: white; border: none;
            padding: 12px 40px; font-size: 1.3rem; border-radius: 50px;
            margin: 10px; cursor: pointer; font-family: 'Cairo', sans-serif;
            box-shadow: 0 5px 0 #1e8449, 0 10px 10px rgba(0,0,0,0.2); 
            transition: all 0.1s; width: 90%; max-width: 350px; font-weight: bold;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }
        .btn-blue { background: linear-gradient(to bottom, #3498db, #2980b9); box-shadow: 0 5px 0 #20638f; }
        .btn-gold { background: linear-gradient(to bottom, #f1c40f, #f39c12); color: var(--primary); box-shadow: 0 5px 0 #d35400; }

        .mode-select { display: flex; gap: 10px; margin-bottom: 20px; width: 90%; max-width: 400px; }
        .mode-btn { flex: 1; padding: 12px; opacity: 0.7; transition: 0.3s; border: 2px solid rgba(255,255,255,0.2); font-size: 1rem; color: white; background: rgba(0,0,0,0.2); border-radius: 12px; cursor: pointer; font-family: 'Cairo', sans-serif;}
        .mode-btn.active { opacity: 1; border-color: var(--gold); background: rgba(241, 196, 15, 0.2); transform: scale(1.05); font-weight: bold; }

        #game-container { display: flex; flex-direction: column; height: 100%; }
        
        #game-view {
            flex: 1; position: relative; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
            background: linear-gradient(to bottom, var(--bg-sky-top), var(--bg-sky-bot));
            overflow: hidden;
            box-shadow: inset 0 -10px 20px rgba(0,0,0,0.1);
        }
        canvas { width: 100%; height: 100%; display: block; }

        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            font-size: 1.3rem; color: white; text-shadow: 2px 2px 0 #000;
            pointer-events: none; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        #controls-area {
            height: auto; /* Ø§Ø±ØªÙØ§Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ */
            min-height: 35vh; /* Ù„ÙƒÙ† Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 35% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            background: var(--secondary);
            padding: 15px 20px calc(20px + env(safe-area-inset-bottom)) 20px;
            display: flex; flex-direction: column; justify-content: flex-start; gap: 15px;
            border-top: 6px solid var(--primary); 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5); z-index: 10;
        }

        #question-box {
            background: #fff; color: var(--primary); padding: 10px; border-radius: 15px;
            text-align: center; font-size: 2rem; font-weight: 800;
            box-shadow: 0 4px 0 #bdc3c7;
            min-height: 80px; display: flex; flex-direction: column; justify-content: center;
        }
        .visual-representation { display: flex; justify-content: center; gap: 6px; margin-top: 5px; flex-wrap: wrap; }
        .dot { width: 14px; height: 14px; background: var(--accent-wrong); border-radius: 50%; display: inline-block; box-shadow: inset -2px -2px rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.1); }

        #options-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; height: 90px; }
        .option-btn {
            background: #ecf0f1; color: var(--primary); border: none;
            font-size: 1.8rem; font-weight: bold; border-radius: 15px; cursor: pointer;
            box-shadow: 0 6px 0 #bdc3c7; transition: transform 0.1s; font-family: 'Cairo', sans-serif; height: 100%;
        }
        .option-btn:active { transform: translateY(6px); box-shadow: none; }
        .option-btn:disabled { opacity: 1; cursor: default; } /* Keep opacity so user sees result */
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; width: 100%; max-width: 400px; }
        .shop-item {
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;
            border: 2px solid transparent; cursor: pointer; position: relative; transition: 0.2s;
        }
        .shop-item:active { transform: scale(0.95); }
        .shop-item.selected { border-color: var(--gold); background: rgba(241, 196, 15, 0.2); box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); }
        .shop-item.locked { opacity: 0.5; filter: grayscale(1); }
        .shop-icon { font-size: 2.5rem; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3)); }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</h1>
        <div class="credits-box">
            <div class="credits-name">ÙÙƒØ±Ø© ÙˆØªØµÙ…ÙŠÙ…: Ø£. Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</div>
            <div class="social-icons">
                <a href="https://wa.me/966566996166" target="_blank"><i class="fab fa-whatsapp"></i></a>
                <a href="https://snapchat.com/t/2tVDWcXq" target="_blank"><i class="fab fa-snapchat"></i></a>
            </div>
        </div>
        <p style="margin: 0 0 10px 0; color: #ecf0f1;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</p>
        <div class="mode-select">
            <button id="mode-lower" class="mode-btn active" onclick="setMode('lower')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</button>
            <button id="mode-upper" class="mode-btn" onclick="setMode('upper')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ù„ÙŠØ§</button>
        </div>
        <button class="btn" onclick="initAudioAndStart()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¹Ø±ÙƒØ©! âš”ï¸</button>
        <button class="btn btn-gold" onclick="showShop()">Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’</button>
    </div>

    <div id="shop-screen" class="screen hidden">
        <h2 style="color:var(--gold)">Ø§Ø®ØªØ± Ø¨Ø·Ù„Ùƒ</h2>
        <p>Ø±ØµÙŠØ¯Ùƒ: <span class="arabic-num" id="shop-coins-disp">Ù </span> ğŸ’°</p>
        <div class="shop-grid" id="shop-items-container"></div>
        <button class="btn btn-blue" onclick="closeShop()">Ø¹ÙˆØ¯Ø©</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: var(--accent-wrong);">Ø³Ù‚Ø·Øª Ø§Ù„Ù‚Ù„Ø¹Ø©!</h1>
        <p style="font-size: 1.5rem;">Ø¬Ù…Ø¹Øª: <span class="arabic-num" id="final-score">Ù </span> Ù†Ù‚Ø·Ø©</p>
        <button class="btn" onclick="resetGame()">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        <button class="btn btn-blue" onclick="location.reload()">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div id="game-container" class="hidden">
        <div id="game-view">
            <canvas id="game-canvas"></canvas>
            <div id="hud">
                <div class="hud-item"><i class="fas fa-heart" style="color:#e74c3c"></i> <span class="arabic-num" id="lives-disp">Ù£</span></div>
                <div class="hud-item"><i class="fas fa-star" style="color:var(--gold)"></i> <span class="arabic-num" id="score-disp">Ù </span></div>
            </div>
        </div>
        <div id="controls-area">
            <div id="question-box">
                <div id="q-text">...</div>
                <div id="q-visual"></div>
            </div>
            <div id="options-grid">
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
            </div>
        </div>
    </div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª ---
        const manifestData = {
            "name": "Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø©", "short_name": "Ø§Ù„Ù‚Ù„Ø¹Ø©", "start_url": ".",
            "display": "standalone", "background_color": "#2c3e50", "theme_color": "#2c3e50",
            "orientation": "portrait",
            "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/3069/3069172.png", "sizes": "192x192", "type": "image/png"}]
        };
        const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        document.getElementById('manifest-placeholder').href = URL.createObjectURL(blob);

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª (Sound System) ---
        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') { // Ding!
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'wrong') { // Buzz
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'shoot') { // Pew
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.start(); osc.stop(audioCtx.currentTime + 0.15);
            } else if (type === 'explosion') { // Boom
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let gameMode = 'lower';
        let score = 0, lives = 3, coins = 0;
        let currentAnswer = 0;
        let gameState = 'start';
        let difficulty = 1;
        
        let savedData = JSON.parse(localStorage.getItem('mathHero_v5')) || { coins: 0, boughtSkins: ['ğŸ‘®â€â™‚ï¸'], currentSkin: 'ğŸ‘®â€â™‚ï¸' };
        coins = savedData.coins;

        const shopItems = [
            { icon: 'ğŸ‘®â€â™‚ï¸', price: 0 }, { icon: 'ğŸ¦¸â€â™‚ï¸', price: 50 },
            { icon: 'ğŸ¥·', price: 100 }, { icon: 'ğŸ¦', price: 200 },
            { icon: 'ğŸ¤–', price: 300 }, { icon: 'ğŸ§™â€â™‚ï¸', price: 500 }
        ];

        let hero = { x: 50, y: 0, sprite: savedData.currentSkin };
        let enemies = [];
        let particles = [];
        let clouds = [];
        let lastSpawnTime = 0;
        let spawnInterval = 2500;
        let groundLevel = 0;

        function toArabicNum(num) {
            return num.toString().replace(/\d/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
        }

        function resizeCanvas() {
            const container = document.getElementById('game-view');
            if(container) {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                groundLevel = canvas.height * 0.75; // Ø§Ù„Ø£Ø±Ø¶ Ø¹Ù†Ø¯ 75% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
                
                // ØªØµØ­ÙŠØ­ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
                hero.y = groundLevel + 5;
                enemies.forEach(e => e.y = groundLevel + 5);
            }
        }
        window.addEventListener('resize', resizeCanvas);

        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© ---
        function initClouds() {
            clouds = [];
            for(let i=0; i<5; i++) {
                clouds.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * (canvas.height/2),
                    speed: 0.2 + Math.random() * 0.3,
                    size: 30 + Math.random() * 40
                });
            }
        }

        function drawEnvironment() {
            // Ø§Ù„Ø³Ù…Ø§Ø¡ (Ù…ØªØ¯Ø±Ø¬Ø© ÙÙŠ CSS)
            
            // Ø§Ù„Ø´Ù…Ø³
            ctx.fillStyle = '#f1c40f';
            ctx.shadowBlur = 20; ctx.shadowColor = 'orange';
            ctx.beginPath(); ctx.arc(canvas.width - 50, 50, 30, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            // Ø§Ù„Ø³Ø­Ø¨
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            clouds.forEach(c => {
                c.x -= c.speed;
                if(c.x < -100) c.x = canvas.width + 100;
                ctx.beginPath();
                ctx.arc(c.x, c.y, c.size, 0, Math.PI*2);
                ctx.arc(c.x + c.size*0.5, c.y - c.size*0.5, c.size*0.8, 0, Math.PI*2);
                ctx.arc(c.x + c.size, c.y, c.size*0.9, 0, Math.PI*2);
                ctx.fill();
            });

            // Ø§Ù„Ø£Ø±Ø¶
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(0, groundLevel, canvas.width, canvas.height - groundLevel);
            // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø´Ø¨
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(0, groundLevel, canvas.width, 10);
            
            // Ø§Ù„Ù‚Ù„Ø¹Ø©
            drawCastle();
        }

        function drawCastle() {
            const w = Math.min(canvas.width * 0.3, 150); // Ù„Ø§ ØªÙƒØ¨Ø± Ø²ÙŠØ§Ø¯Ø©
            const h = canvas.height * 0.45;
            const x = 10;
            const base = groundLevel;

            // Ø§Ù„Ø¸Ù„
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(x + w/2, base, w/2, 10, 0, 0, Math.PI*2); ctx.fill();

            // Ø§Ù„Ø¨Ø±Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(x, base - h + 30, w, h - 30);
            
            // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·ÙˆØ¨
            ctx.fillStyle = '#95a5a6';
            for(let i=0; i<5; i++) {
                ctx.fillRect(x + (Math.random()*w), base - (Math.random()*h), 10, 5);
            }

            // Ø§Ù„Ø´Ø±ÙØ§Øª
            ctx.fillStyle = '#34495e';
            ctx.fillRect(x - 5, base - h + 20, w + 10, 15);
            for(let i=0; i<4; i++) {
                ctx.fillRect(x + (i * (w/3.5)), base - h, w/5, 20);
            }

            // Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
            ctx.fillStyle = '#4e342e';
            ctx.beginPath(); ctx.arc(x + w/2, base, w/3, Math.PI, 0); ctx.fill();
            // Ø­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
            ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(x+w/2, base-w/3); ctx.lineTo(x+w/2, base); ctx.stroke();
            
            // Ø§Ù„Ø¹Ù„Ù…
            const flagY = base - h;
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(x + w/2, flagY); ctx.lineTo(x + w/2, flagY - 40); ctx.stroke();
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath(); ctx.moveTo(x + w/2, flagY - 40); ctx.lineTo(x + w + 20, flagY - 30); ctx.lineTo(x + w/2, flagY - 20); ctx.fill();
        }

        // --- Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        function initAudioAndStart() {
            initAudio(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØµÙˆØªÙŠ
            startGame();
        }

        function startGame() {
            gameState = 'playing';
            score = 0; lives = 3; difficulty = 1; spawnInterval = 2500;
            enemies = []; particles = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            
            // ÙØ±Ø¶ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø­Ø¬Ø§Ù… ÙÙˆØ±Ø§Ù‹
            resizeCanvas();
            initClouds();
            updateHUD();
            generateNewQuestion();
            gameLoop(0);
        }

        function updateHUD() {
            document.querySelectorAll('.arabic-num').forEach(el => {
                if(el.id.includes('score')) el.innerText = toArabicNum(score);
                if(el.id.includes('lives')) el.innerText = toArabicNum(lives);
                if(el.id.includes('coins')) el.innerText = toArabicNum(coins);
            });
            localStorage.setItem('mathHero_v5', JSON.stringify({ coins, boughtSkins: savedData.boughtSkins, currentSkin: savedData.currentSkin }));
        }

        function generateNewQuestion() {
            let n1, n2, op, vis = '';
            
            if (gameMode === 'lower') {
                if (Math.random() > 0.5) { // Ø¬Ù…Ø¹
                    n1 = Math.floor(Math.random() * 6);
                    n2 = Math.floor(Math.random() * (11 - n1));
                    currentAnswer = n1 + n2;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} + ${toArabicNum(n2)} = ØŸ`;
                    vis = drawDots(n1) + '<span style="font-size:1.5rem">+</span>' + drawDots(n2);
                } else { // Ø·Ø±Ø­
                    n1 = Math.floor(Math.random() * 11);
                    n2 = Math.floor(Math.random() * (n1 + 1));
                    currentAnswer = n1 - n2;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} âˆ’ ${toArabicNum(n2)} = ØŸ`;
                    vis = drawDots(n1);
                }
            } else {
                if (Math.random() > 0.5) { // Ø¶Ø±Ø¨
                    n1 = Math.floor(Math.random() * 11);
                    n2 = Math.floor(Math.random() * 11);
                    currentAnswer = n1 * n2;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} Ã— ${toArabicNum(n2)} = ØŸ`;
                } else { // Ù‚Ø³Ù…Ø©
                    n2 = Math.floor(Math.random() * 9) + 1;
                    currentAnswer = Math.floor(Math.random() * 11);
                    n1 = n2 * currentAnswer;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} Ã· ${toArabicNum(n2)} = ØŸ`;
                }
            }
            document.getElementById('q-visual').innerHTML = vis;
            
            let opts = [currentAnswer];
            while(opts.length < 3) {
                let r = currentAnswer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random()*5)+1);
                if(r >= 0 && !opts.includes(r)) opts.push(r);
            }
            opts.sort(() => Math.random() - 0.5);
            
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach((b, i) => {
                b.innerText = toArabicNum(opts[i]);
                b.setAttribute('data-val', opts[i]);
                b.disabled = false;
                b.style.transform = 'scale(1)';
                b.style.backgroundColor = '#ecf0f1';
                b.style.color = 'var(--primary)';
                b.style.borderColor = 'transparent';
                b.style.border = 'none';
            });
        }

        function drawDots(n) {
            if(gameMode === 'upper') return '';
            let s = ''; for(let i=0;i<n;i++) s+='<span class="dot"></span>';
            return `<div class="visual-representation">${s}</div>`;
        }

        function checkAnswer(btn) {
            try {
                let val = parseInt(btn.getAttribute('data-val'));
                const allBtns = document.querySelectorAll('.option-btn');
                
                // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±
                if(btn.disabled) return;
                allBtns.forEach(b => b.disabled = true);
                
                if(val === currentAnswer) {
                    btn.style.backgroundColor = '#2ecc71';
                    btn.style.color = 'white';
                    btn.style.transform = 'scale(1.1)';
                    playSound('correct');
                    score += 10; coins += 2;
                    
                    // Ø¥Ø·Ù„Ø§Ù‚ Ù…Ù‚Ø°ÙˆÙ (Ø¨ØµØ±ÙŠ ÙÙ‚Ø·)
                    fireProjectile();

                    if(enemies.length > 0) { 
                        // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙŠØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø°ÙˆÙ
                        setTimeout(() => {
                            if(enemies[0]) {
                                createExplosion(enemies[0].x, enemies[0].y); 
                                enemies.shift();
                                playSound('explosion');
                            }
                        }, 200);
                    }
                    updateHUD();
                    setTimeout(generateNewQuestion, 800);
                } else {
                    btn.style.backgroundColor = '#e74c3c';
                    btn.style.color = 'white';
                    playSound('wrong');
                    document.getElementById('controls-area').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('controls-area').classList.remove('shake');
                        allBtns.forEach(b => { 
                            b.disabled = false; 
                            b.style.backgroundColor = '#ecf0f1'; 
                            b.style.color = 'var(--primary)'; 
                            b.style.transform = 'scale(1)';
                        });
                    }, 500);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function fireProjectile() {
            // Ø±Ø³Ù… ÙƒØ±Ø© Ù†Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù…Ù† Ø§Ù„Ø¨Ø·Ù„
            let projX = canvas.width * 0.15;
            let projY = groundLevel - 30;
            let targetX = enemies.length > 0 ? enemies[0].x : canvas.width;
            
            // Ù‡Ù†Ø§ Ù…Ø¬Ø±Ø¯ ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø³Ø±ÙŠØ¹
            ctx.fillStyle = 'orange';
            ctx.beginPath(); ctx.arc(projX, projY, 10, 0, Math.PI*2); ctx.fill();
        }

        function gameLoop(t) {
            if(gameState !== 'playing') return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            drawEnvironment();

            // Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ù„
            ctx.font = `${canvas.height * 0.15}px Cairo`;
            ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 10;
            ctx.textAlign = 'center';
            ctx.fillText(hero.sprite, canvas.width * 0.15, groundLevel + 5);
            ctx.shadowBlur = 0;

            // Ø¥Ø¶Ø§ÙØ© ÙˆØ­ÙˆØ´ (Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµØ­ÙŠØ­)
            if(t - lastSpawnTime > spawnInterval) {
                let baseSpeed = 1.5; 
                let screenFactor = canvas.width > 800 ? 0.001 : 0.003; 
                
                enemies.push({
                    x: canvas.width + 50,
                    y: groundLevel + 5, // Ø§Ø³ØªØ®Ø¯Ø§Ù… GroundLevel Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
                    speed: (canvas.width * screenFactor + baseSpeed) * difficulty,
                    sprite: ['ğŸ‘¾','ğŸ‘º','ğŸ‘¹','ğŸ‰','ğŸ¦–'][Math.floor(Math.random()*5)],
                    walkOffset: 0
                });
                lastSpawnTime = t;
            }

            // Ø­Ø±ÙƒØ© Ø§Ù„ÙˆØ­ÙˆØ´
            for(let i=enemies.length-1; i>=0; i--) {
                let e = enemies[i];
                e.x -= e.speed;
                e.walkOffset += 0.2;
                let bounce = Math.sin(e.walkOffset) * 5; // Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø´ÙŠ
                
                ctx.font = `${canvas.height * 0.12}px Cairo`;
                ctx.fillText(e.sprite, e.x, e.y + bounce);
                
                if(e.x < canvas.width * 0.2) {
                    enemies.splice(i,1); lives--; updateHUD();
                    playSound('wrong');
                    document.getElementById('game-view').classList.add('shake');
                    setTimeout(()=>document.getElementById('game-view').classList.remove('shake'), 400);
                    if(lives <= 0) {
                        gameState = 'over';
                        document.getElementById('game-container').classList.add('hidden');
                        document.getElementById('game-over-screen').classList.remove('hidden');
                    }
                }
            }

            // Ø§Ù†ÙØ¬Ø§Ø±Ø§Øª
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.04;
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                if(p.life<=0) particles.splice(i,1);
            }
            ctx.globalAlpha = 1;

            requestAnimationFrame(gameLoop);
        }

        function createExplosion(x, y) {
            for(let i=0; i<25; i++) {
                particles.push({
                    x: x, y: y - 20,
                    vx: (Math.random()-0.5) * 15, vy: (Math.random()-0.5) * 15,
                    life: 1, size: Math.random()*8+2,
                    color: `hsl(${Math.random()*60 + 10}, 100%, 50%)` // Ø£Ù„ÙˆØ§Ù† Ù†Ø§Ø±ÙŠØ©
                });
            }
        }

        function renderShop() {
            const c = document.getElementById('shop-items-container'); c.innerHTML = '';
            shopItems.forEach(item => {
                let owned = savedData.boughtSkins.includes(item.icon);
                let div = document.createElement('div');
                div.className = `shop-item ${savedData.currentSkin === item.icon ? 'selected' : ''} ${!owned ? 'locked' : ''}`;
                div.innerHTML = `<div class="shop-icon">${item.icon}</div><div>${owned ? 'âœ”' : toArabicNum(item.price)}</div>`;
                div.onclick = () => {
                    if(owned) { 
                        savedData.currentSkin = item.icon; hero.sprite = item.icon; 
                        renderShop(); updateHUD(); 
                    }
                    else if(coins >= item.price) {
                        coins -= item.price; savedData.boughtSkins.push(item.icon);
                        savedData.currentSkin = item.icon; hero.sprite = item.icon;
                        playSound('correct');
                        renderShop(); updateHUD();
                    }
                }
                c.appendChild(div);
            });
        }
        function showShop() { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('shop-screen').classList.remove('hidden'); renderShop(); }
        function closeShop() { document.getElementById('shop-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }
        function setMode(m) { gameMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById('mode-'+m).classList.add('active'); }
        function resetGame() { document.getElementById('game-over-screen').classList.add('hidden'); startGame(); }

    </script>
</body>
</html>
