<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© | Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" id="manifest-placeholder">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3069/3069172.png">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent-correct: #2ecc71;
            --accent-wrong: #e74c3c;
            --gold: #f1c40f;
            --bg-sky-top: #3498db;
            --bg-sky-bot: #87CEEB;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Cairo', sans-serif;
            background-color: var(--primary);
            height: 100vh; height: 100dvh;
            overflow: hidden; touch-action: manipulation; user-select: none;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; color: white; text-align: center; padding: 20px;
        }
        .hidden { display: none !important; }

        /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        h1 {
            font-size: 2.2rem; margin: 0 0 20px 0; color: var(--gold);
            text-shadow: 3px 3px 0 rgba(0,0,0,0.5); font-weight: 800;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60); color: white; border: none;
            padding: 12px 30px; font-size: 1.3rem; border-radius: 50px;
            margin: 10px; cursor: pointer; font-family: 'Cairo', sans-serif;
            box-shadow: 0 5px 0 #1e8449, 0 10px 10px rgba(0,0,0,0.2); 
            transition: all 0.1s; width: 85%; max-width: 350px; font-weight: bold;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }
        .btn-blue { background: linear-gradient(to bottom, #3498db, #2980b9); box-shadow: 0 5px 0 #20638f; }
        .btn-gold { background: linear-gradient(to bottom, #f1c40f, #f39c12); color: var(--primary); box-shadow: 0 5px 0 #d35400; }
        
        /* Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª */
        .btn-install {
            background: #9b59b6; box-shadow: 0 5px 0 #8e44ad; font-size: 1rem; width: auto; padding: 10px 20px;
            margin-top: 5px;
        }

        .mode-select { display: flex; gap: 10px; margin-bottom: 20px; width: 90%; max-width: 400px; }
        .mode-btn { flex: 1; padding: 12px; opacity: 0.7; transition: 0.3s; border: 2px solid rgba(255,255,255,0.2); font-size: 1rem; color: white; background: rgba(0,0,0,0.2); border-radius: 12px; cursor: pointer; font-family: 'Cairo', sans-serif;}
        .mode-btn.active { opacity: 1; border-color: var(--gold); background: rgba(241, 196, 15, 0.2); transform: scale(1.05); font-weight: bold; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) */
        .footer-credits {
            position: absolute; bottom: 20px; left: 0; right: 0;
            text-align: center; color: rgba(255,255,255,0.8);
        }
        .credits-name { font-size: 1rem; margin-bottom: 10px; font-weight: bold; }
        .social-icons { display: flex; justify-content: center; gap: 25px; }
        .social-icons a {
            color: white; font-size: 2rem; text-decoration: none;
            transition: transform 0.2s; display: inline-block;
        }
        .social-icons a:hover { transform: scale(1.2); }
        .fa-whatsapp { color: #25D366; }
        .fa-snapchat { color: #FFFC00; text-shadow: 0 0 5px #000; }

        /* Ø§Ù„Ù„Ø¹Ø¨Ø© */
        #game-container { display: flex; flex-direction: column; height: 100%; }
        
        #game-view {
            flex: 1; position: relative;
            background: linear-gradient(to bottom, var(--bg-sky-top), var(--bg-sky-bot));
            overflow: hidden;
            box-shadow: inset 0 -10px 20px rgba(0,0,0,0.1);
        }

        canvas { width: 100%; height: 100%; display: block; }

        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.2rem; color: white; text-shadow: 2px 2px 0 #000;
            pointer-events: none; z-index: 20;
        }
        .hud-group { display: flex; gap: 15px; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }

        #controls-area {
            height: auto; min-height: 35vh;
            background: var(--secondary);
            padding: 15px 20px calc(20px + env(safe-area-inset-bottom)) 20px;
            display: flex; flex-direction: column; gap: 15px;
            border-top: 6px solid var(--primary); 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5); z-index: 10;
        }

        #question-box {
            background: #fff; color: var(--primary); padding: 10px; border-radius: 15px;
            text-align: center; font-size: 2rem; font-weight: 800;
            box-shadow: 0 4px 0 #bdc3c7;
            min-height: 80px; display: flex; flex-direction: column; justify-content: center;
        }
        .visual-representation { display: flex; justify-content: center; gap: 6px; margin-top: 5px; flex-wrap: wrap; }
        
        .dot { 
            width: 16px; height: 16px; 
            background: var(--accent-wrong); 
            border-radius: 50%; display: inline-block; 
            box-shadow: inset -2px -2px rgba(0,0,0,0.2); 
            border: 1px solid rgba(0,0,0,0.1); 
            position: relative;
        }
        
        .dot.crossed {
            background: #bdc3c7; opacity: 0.6;
        }
        .dot.crossed::after { content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 3px; background: #c0392b; transform: translate(-50%, -50%) rotate(45deg); }
        .dot.crossed::before { content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 3px; background: #c0392b; transform: translate(-50%, -50%) rotate(-45deg); }

        #options-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; height: 90px; }
        .option-btn {
            background: #ecf0f1; color: var(--primary); border: none;
            font-size: 1.8rem; font-weight: bold; border-radius: 15px; cursor: pointer;
            box-shadow: 0 6px 0 #bdc3c7; transition: transform 0.1s; font-family: 'Cairo', sans-serif; height: 100%;
        }
        .option-btn:active { transform: translateY(6px); box-shadow: none; }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; width: 100%; max-width: 400px; }
        .shop-item {
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;
            border: 2px solid transparent; cursor: pointer; position: relative; transition: 0.2s;
        }
        .shop-item:active { transform: scale(0.95); }
        .shop-item.selected { border-color: var(--gold); background: rgba(241, 196, 15, 0.2); box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); }
        .shop-item.locked { opacity: 0.5; filter: grayscale(1); }
        .shop-icon { font-size: 2.5rem; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3)); }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1 style="margin-top: 50px;">Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</h1>
        
        <p style="margin: 0 0 10px 0; color: #ecf0f1;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</p>
        <div class="mode-select">
            <button id="mode-lower" class="mode-btn active" onclick="setMode('lower')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</button>
            <button id="mode-upper" class="mode-btn" onclick="setMode('upper')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ù„ÙŠØ§</button>
        </div>
        
        <button class="btn" onclick="initAudioAndStart()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ! âš”ï¸</button>
        <button class="btn btn-gold" onclick="showShop()">Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’</button>
        
        <button id="install-btn" class="btn btn-install" onclick="installApp()" style="display:none">
            <i class="fas fa-download"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        </button>

        <div class="footer-credits">
            <div class="credits-name">ÙÙƒØ±Ø© ÙˆØªØµÙ…ÙŠÙ…: Ø£. Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</div>
            <div class="social-icons">
                <a href="https://wa.me/966566996166" target="_blank"><i class="fab fa-whatsapp"></i></a>
                <a href="https://snapchat.com/t/2tVDWcXq" target="_blank"><i class="fab fa-snapchat"></i></a>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="screen hidden">
        <h2 style="color:var(--gold)">Ø§Ø®ØªØ± Ø¨Ø·Ù„Ùƒ</h2>
        <p>Ø±ØµÙŠØ¯Ùƒ: <span class="arabic-num" id="shop-coins-disp">Ù </span> ğŸ’°</p>
        <div class="shop-grid" id="shop-items-container"></div>
        <button class="btn btn-blue" onclick="closeShop()">Ø¹ÙˆØ¯Ø©</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: var(--accent-wrong);">Ø³Ù‚Ø·Øª Ø§Ù„Ù‚Ù„Ø¹Ø©!</h1>
        <p style="font-size: 1.5rem;">Ø¬Ù…Ø¹Øª: <span class="arabic-num" id="final-score">Ù </span> Ù†Ù‚Ø·Ø©</p>
        <button class="btn" onclick="resetGame()">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        <button class="btn btn-blue" onclick="location.reload()">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div id="game-container" class="hidden">
        <div id="game-view">
            <canvas id="game-canvas"></canvas>
            <div id="hud">
                <div class="hud-group">
                    <div><i class="fas fa-heart" style="color:#e74c3c"></i> <span class="arabic-num" id="lives-disp">Ù£</span></div>
                    <div><i class="fas fa-star" style="color:var(--gold)"></i> <span class="arabic-num" id="score-disp">Ù </span></div>
                </div>
            </div>
        </div>
        <div id="controls-area">
            <div id="question-box">
                <div id="q-text">...</div>
                <div id="q-visual"></div>
            </div>
            <div id="options-grid">
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª (Blob Trick)
        const manifestData = {
            "name": "Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø©", "short_name": "Ø§Ù„Ù‚Ù„Ø¹Ø©", "start_url": ".",
            "display": "standalone", "background_color": "#2c3e50", "theme_color": "#2c3e50",
            "orientation": "portrait",
            "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/3069/3069172.png", "sizes": "192x192", "type": "image/png"}]
        };
        const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        document.getElementById('manifest-placeholder').href = URL.createObjectURL(blob);

        // Ù…Ù†Ø·Ù‚ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¢ÙŠÙÙˆÙ† (ØªØ¹Ù„ÙŠÙ…Ø§Øª)
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if(isIOS && !window.navigator.standalone) {
            installBtn.style.display = 'block';
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') installBtn.style.display = 'none';
                    deferredPrompt = null;
                });
            } else if (isIOS) {
                alert("Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠÙÙˆÙ†:\nØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ØŒ Ø«Ù… Ø§Ø®ØªØ± 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'.");
            } else {
                alert("Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ (Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·) ÙˆØ§Ø®ØªØ± 'ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'.");
            }
        }

        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') { 
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'wrong') { 
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2); gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let gameMode = 'lower';
        let score = 0, lives = 3, coins = 0;
        let currentAnswer = 0;
        let gameState = 'start';
        let difficulty = 1;
        
        let savedData = JSON.parse(localStorage.getItem('mathHero_v11')) || { coins: 0, boughtSkins: ['ğŸ¤´'], currentSkin: 'ğŸ¤´' };
        coins = savedData.coins;

        const shopItems = [
            { icon: 'ğŸ¤´', price: 0 }, { icon: 'ğŸ¦¸â€â™‚ï¸', price: 50 },
            { icon: 'ğŸ¥·', price: 100 }, { icon: 'ğŸ¦', price: 200 },
            { icon: 'ğŸ¤–', price: 300 }, { icon: 'ğŸ§”', price: 500 }
        ];

        let hero = { x: 50, y: 0, sprite: savedData.currentSkin };
        let enemies = [];
        let particles = [];
        let clouds = [];
        let groundLevel = 0;
        let castleX = 0;

        function toArabicNum(num) {
            return num.toString().replace(/\d/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
        }

        function resizeCanvas() {
            const container = document.getElementById('game-view');
            if(container) {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                groundLevel = canvas.height * 0.75;
                hero.y = groundLevel + 5;
                castleX = canvas.width * 0.25;
                enemies.forEach(e => e.y = groundLevel + 5);
            }
        }
        window.addEventListener('resize', resizeCanvas);

        function initClouds() {
            clouds = [];
            for(let i=0; i<5; i++) {
                clouds.push({
                    x: Math.random() * canvas.width, y: Math.random() * (canvas.height/2),
                    speed: 0.1 + Math.random() * 0.2, size: 30 + Math.random() * 40
                });
            }
        }

        function drawEnvironment() {
            ctx.fillStyle = '#f1c40f';
            ctx.shadowBlur = 20; ctx.shadowColor = 'orange';
            ctx.beginPath(); ctx.arc(canvas.width - 50, 50, 30, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            clouds.forEach(c => {
                c.x -= c.speed;
                if(c.x < -100) c.x = canvas.width + 100;
                ctx.beginPath();
                ctx.arc(c.x, c.y, c.size, 0, Math.PI*2);
                ctx.arc(c.x + c.size*0.5, c.y - c.size*0.5, c.size*0.8, 0, Math.PI*2);
                ctx.arc(c.x + c.size, c.y, c.size*0.9, 0, Math.PI*2);
                ctx.fill();
            });

            ctx.fillStyle = '#27ae60'; ctx.fillRect(0, groundLevel, canvas.width, canvas.height - groundLevel);
            ctx.fillStyle = '#2ecc71'; ctx.fillRect(0, groundLevel, canvas.width, 10);
            
            ctx.strokeStyle = '#bdc3c7'; ctx.lineWidth = 4; ctx.setLineDash([10, 5]);
            ctx.beginPath(); ctx.moveTo(castleX + 30, groundLevel); ctx.lineTo(castleX + 30, groundLevel - 150); ctx.stroke();
            ctx.setLineDash([]);

            drawCastle();
        }

        function drawCastle() {
            const w = Math.min(canvas.width * 0.25, 120);
            const h = canvas.height * 0.45;
            const x = 10;
            const base = groundLevel;

            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(x + w/2, base, w/2, 10, 0, 0, Math.PI*2); ctx.fill();

            ctx.fillStyle = '#7f8c8d'; ctx.fillRect(x, base - h + 30, w, h - 30);
            ctx.fillStyle = '#34495e';
            ctx.fillRect(x - 5, base - h + 20, w + 10, 15);
            ctx.fillStyle = '#4e342e';
            ctx.beginPath(); ctx.arc(x + w/2, base, w/3, Math.PI, 0); ctx.fill();
            
            const flagY = base - h;
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(x + w/2, flagY); ctx.lineTo(x + w/2, flagY - 40); ctx.stroke();
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath(); ctx.moveTo(x + w/2, flagY - 40); ctx.lineTo(x + w + 20, flagY - 30); ctx.lineTo(x + w/2, flagY - 20); ctx.fill();
        }

        function initAudioAndStart() {
            initAudio(); startGame();
        }

        function startGame() {
            gameState = 'playing';
            score = 0; lives = 3; difficulty = 1;
            enemies = []; particles = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            resizeCanvas(); initClouds(); updateHUD(); generateNewQuestion(); gameLoop(0);
        }

        function updateHUD() {
            document.querySelectorAll('.arabic-num').forEach(el => {
                if(el.id.includes('score')) el.innerText = toArabicNum(score);
                if(el.id.includes('lives')) el.innerText = toArabicNum(lives);
                if(el.id.includes('coins')) el.innerText = toArabicNum(coins);
            });
            localStorage.setItem('mathHero_v11', JSON.stringify({ coins, boughtSkins: savedData.boughtSkins, currentSkin: savedData.currentSkin }));
        }

        function generateNewQuestion() {
            let n1, n2, op, vis = '';
            if (gameMode === 'lower') {
                if (Math.random() > 0.5) {
                    n1 = Math.floor(Math.random() * 6); n2 = Math.floor(Math.random() * (11 - n1));
                    currentAnswer = n1 + n2;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} + ${toArabicNum(n2)} = ØŸ`;
                    vis = drawDots(n1, false) + '<span style="font-size:1.5rem">+</span>' + drawDots(n2, false);
                } else {
                    n1 = Math.floor(Math.random() * 11); 
                    n2 = Math.floor(Math.random() * (n1 + 1));
                    currentAnswer = n1 - n2;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} âˆ’ ${toArabicNum(n2)} = ØŸ`;
                    vis = drawSubtractionVisual(n1, n2);
                }
            } else {
                if (Math.random() > 0.5) {
                    n1 = Math.floor(Math.random() * 11); n2 = Math.floor(Math.random() * 11);
                    currentAnswer = n1 * n2;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} Ã— ${toArabicNum(n2)} = ØŸ`;
                } else {
                    n2 = Math.floor(Math.random() * 9) + 1; currentAnswer = Math.floor(Math.random() * 11); n1 = n2 * currentAnswer;
                    document.getElementById('q-text').innerText = `${toArabicNum(n1)} Ã· ${toArabicNum(n2)} = ØŸ`;
                }
            }
            document.getElementById('q-visual').innerHTML = vis;
            
            let opts = [currentAnswer];
            while(opts.length < 3) {
                let r = currentAnswer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random()*5)+1);
                if(r >= 0 && !opts.includes(r)) opts.push(r);
            }
            opts.sort(() => Math.random() - 0.5);
            
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach((b, i) => {
                b.innerText = toArabicNum(opts[i]);
                b.setAttribute('data-val', opts[i]);
                b.disabled = false;
                b.style.transform = 'scale(1)';
                b.style.backgroundColor = '#ecf0f1';
                b.style.color = 'var(--primary)';
            });
        }

        function drawDots(n, crossed = false) {
            if(gameMode === 'upper') return '';
            let s = ''; 
            for(let i=0;i<n;i++) {
                s += `<span class="dot ${crossed ? 'crossed' : ''}"></span>`;
            }
            return `<div class="visual-representation">${s}</div>`;
        }

        function drawSubtractionVisual(total, crossedCount) {
            if(gameMode === 'upper') return '';
            let s = '';
            for(let i=0; i<total; i++) {
                let isCrossed = i >= (total - crossedCount); 
                s += `<span class="dot ${isCrossed ? 'crossed' : ''}"></span>`;
            }
            return `<div class="visual-representation">${s}</div>`;
        }

        function checkAnswer(btn) {
            try {
                let val = parseInt(btn.getAttribute('data-val'));
                const allBtns = document.querySelectorAll('.option-btn');
                if(btn.disabled) return;
                allBtns.forEach(b => b.disabled = true);
                
                if(val === currentAnswer) {
                    btn.style.backgroundColor = '#2ecc71'; btn.style.color = 'white'; btn.style.transform = 'scale(1.1)';
                    playSound('correct'); score += 10; coins += 2;
                    fireProjectile();
                    setTimeout(() => {
                        if(enemies.length > 0) { 
                            createExplosion(enemies[0].x, enemies[0].y); 
                            enemies.shift(); 
                            playSound('explosion'); 
                        }
                    }, 200);
                    updateHUD(); setTimeout(generateNewQuestion, 800);
                } else {
                    btn.style.backgroundColor = '#e74c3c'; btn.style.color = 'white';
                    playSound('wrong');
                    document.getElementById('controls-area').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('controls-area').classList.remove('shake');
                        allBtns.forEach(b => { 
                            b.disabled = false; b.style.backgroundColor = '#ecf0f1'; b.style.color = 'var(--primary)'; b.style.transform = 'scale(1)';
                        });
                    }, 500);
                }
            } catch (e) { console.error(e); }
        }

        function fireProjectile() {
            let projX = canvas.width * 0.15; let projY = groundLevel - 30;
            ctx.fillStyle = 'orange'; ctx.beginPath(); ctx.arc(projX, projY, 10, 0, Math.PI*2); ctx.fill();
        }

        function gameLoop(t) {
            if(gameState !== 'playing') return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            drawEnvironment();

            ctx.font = `${canvas.height * 0.15}px Cairo`; ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 10;
            ctx.textAlign = 'center'; ctx.fillText(hero.sprite, canvas.width * 0.15, groundLevel + 5);
            ctx.shadowBlur = 0;

            if(enemies.length === 0) {
                 let baseSpeed = 1.5; 
                 enemies.push({
                    x: canvas.width + 50, y: groundLevel + 5,
                    speed: baseSpeed * difficulty,
                    sprite: ['ğŸ‘¾','ğŸ‘º','ğŸ‘¹','ğŸ‰','ğŸ¦–'][Math.floor(Math.random()*5)],
                    walkOffset: 0,
                    attackTimer: 0,
                    maxAttackTime: 900
                });
            } else if (enemies.length < 2) {
                let lastEnemy = enemies[enemies.length-1];
                if (lastEnemy.x < canvas.width - 250) {
                    let baseSpeed = 1.5; 
                     enemies.push({
                        x: canvas.width + 50, y: groundLevel + 5,
                        speed: baseSpeed * difficulty,
                        sprite: ['ğŸ‘¾','ğŸ‘º','ğŸ‘¹','ğŸ‰','ğŸ¦–'][Math.floor(Math.random()*5)],
                        walkOffset: 0,
                        attackTimer: 0,
                        maxAttackTime: 900
                    });
                }
            }

            for(let i=0; i<enemies.length; i++) {
                let e = enemies[i];
                let stopPoint = castleX + 40 + (i * 70);

                if (e.x > stopPoint) {
                    e.x -= e.speed;
                    e.walkOffset += 0.15;
                    let bounce = Math.sin(e.walkOffset) * 5;
                    ctx.font = `${canvas.height * 0.12}px Cairo`;
                    ctx.fillText(e.sprite, e.x, e.y + bounce);
                } else {
                    e.x = stopPoint;
                    ctx.font = `${canvas.height * 0.12}px Cairo`;
                    ctx.fillText(e.sprite, e.x, e.y);

                    if (i === 0) {
                        e.attackTimer++;
                        let barWidth = 60;
                        let percent = e.attackTimer / e.maxAttackTime;
                        ctx.fillStyle = "#555";
                        ctx.fillRect(e.x - barWidth/2, e.y - 70, barWidth, 8);
                        ctx.fillStyle = percent > 0.7 ? "#e74c3c" : "#2ecc71";
                        ctx.fillRect(e.x - barWidth/2, e.y - 70, barWidth * (1-percent), 8);

                        if (e.attackTimer >= e.maxAttackTime) {
                            lives--; updateHUD(); playSound('wrong');
                            document.getElementById('game-view').classList.add('shake');
                            setTimeout(()=>document.getElementById('game-view').classList.remove('shake'), 400);
                            createExplosion(e.x, e.y);
                            enemies.shift(); 
                            i--; 
                            if(lives <= 0) {
                                gameState = 'over';
                                document.getElementById('game-container').classList.add('hidden');
                                document.getElementById('game-over-screen').classList.remove('hidden');
                            }
                        }
                    } else {
                         ctx.font = "20px Arial"; ctx.fillStyle = "#fff";
                         ctx.fillText("â³", e.x, e.y - 60);
                    }
                }
            }

            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.04;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                if(p.life<=0) particles.splice(i,1);
            }
            ctx.globalAlpha = 1;
            requestAnimationFrame(gameLoop);
        }

        function createExplosion(x, y) {
            for(let i=0; i<25; i++) {
                particles.push({
                    x: x, y: y - 20, vx: (Math.random()-0.5) * 15, vy: (Math.random()-0.5) * 15,
                    life: 1, size: Math.random()*8+2, color: `hsl(${Math.random()*60 + 10}, 100%, 50%)`
                });
            }
        }

        function renderShop() {
            const c = document.getElementById('shop-items-container'); c.innerHTML = '';
            shopItems.forEach(item => {
                let owned = savedData.boughtSkins.includes(item.icon);
                let div = document.createElement('div');
                div.className = `shop-item ${savedData.currentSkin === item.icon ? 'selected' : ''} ${!owned ? 'locked' : ''}`;
                div.innerHTML = `<div class="shop-icon">${item.icon}</div><div>${owned ? 'âœ”' : toArabicNum(item.price)}</div>`;
                div.onclick = () => {
                    if(owned) { savedData.currentSkin = item.icon; hero.sprite = item.icon; renderShop(); updateHUD(); }
                    else if(coins >= item.price) {
                        coins -= item.price; savedData.boughtSkins.push(item.icon); savedData.currentSkin = item.icon; hero.sprite = item.icon;
                        playSound('correct'); renderShop(); updateHUD();
                    }
                }
                c.appendChild(div);
            });
        }
        function showShop() { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('shop-screen').classList.remove('hidden'); renderShop(); }
        function closeShop() { document.getElementById('shop-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }
        function setMode(m) { gameMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById('mode-'+m).classList.add('active'); }
        function resetGame() { document.getElementById('game-over-screen').classList.add('hidden'); startGame(); }
    </script>
</body>
</html>
