<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© | Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent-correct: #2ecc71;
            --accent-wrong: #e74c3c;
            --gold: #f1c40f;
            --bg-sky: #87CEEB;
            --bg-ground: #7f8c8d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            background-color: var(--primary);
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .hidden { display: none !important; }

        h1 {
            font-size: 2.5rem; margin: 0 0 10px 0;
            color: var(--gold); text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 800;
        }
        
        .credits-box {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 400px;
        }
        .credits-name { font-size: 1.1rem; margin-bottom: 10px; color: #ecf0f1; }
        .social-icons { display: flex; justify-content: center; gap: 25px; }
        .social-icons a {
            color: white; font-size: 2rem; text-decoration: none;
            transition: transform 0.2s; display: inline-block;
        }
        .social-icons a:hover { transform: scale(1.2); }
        .fa-whatsapp { color: #25D366; }
        .fa-snapchat { color: #FFFC00; text-shadow: 0 0 2px #000; }

        .btn {
            background: var(--accent-correct); color: white; border: none;
            padding: 12px 30px; font-size: 1.3rem; border-radius: 50px;
            margin: 8px; cursor: pointer; font-family: 'Cairo', sans-serif;
            box-shadow: 0 4px 0 #27ae60; transition: all 0.1s; width: 85%; max-width: 350px; font-weight: bold;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-blue { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-gold { background: var(--gold); color: var(--primary); box-shadow: 0 4px 0 #c49f0c; }

        .mode-select { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; max-width: 400px; justify-content: center;}
        .mode-btn { flex: 1; padding: 10px; opacity: 0.5; transition: 0.3s; border: 3px solid transparent; }
        .mode-btn.active { opacity: 1; border-color: var(--gold); transform: scale(1.05); }

        /* --- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        #game-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Ù‚Ø³Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ) */
        #game-view {
            flex: 3; /* ÙŠØ£Ø®Ø° 3/5 Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            position: relative;
            background: linear-gradient(to bottom, var(--bg-sky) 70%, var(--bg-ground) 70%);
            overflow: hidden;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ù‚Ø§Ø· */
        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            font-size: 1.2rem; color: white; text-shadow: 1px 1px 2px #000;
            pointer-events: none;
        }
        .hud-item span { font-weight: bold; margin-right: 5px; }

        /* Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³ÙÙ„ÙŠ) */
        #controls-area {
            flex: 2; /* ÙŠØ£Ø®Ø° 2/5 Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            background: var(--secondary);
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            border-top: 4px solid var(--primary);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        #question-box {
            background: white; color: var(--primary);
            padding: 15px; border-radius: 15px;
            text-align: center; font-size: 2rem; font-weight: 800;
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.1);
            min-height: 80px; display: flex; flex-direction: column; justify-content: center;
        }
        .visual-representation { display: flex; justify-content: center; gap: 5px; margin-top: 5px; }
        .dot { width: 12px; height: 12px; background: var(--accent-wrong); border-radius: 50%; display: inline-block; }

        #options-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;
        }
        .option-btn {
            background: white; color: var(--primary); border: none;
            padding: 15px 5px; font-size: 1.8rem; font-weight: bold;
            border-radius: 12px; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: transform 0.1s;
            font-family: 'Cairo', sans-serif;
        }
        .option-btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        /* Ø§Ù„Ù…ØªØ¬Ø± */
        .shop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;
            max-width: 500px; width: 100%;
        }
        .shop-item {
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px;
            border: 3px solid transparent; cursor: pointer; position: relative;
        }
        .shop-item.selected { border-color: var(--gold); background: rgba(241, 196, 15, 0.2); }
        .shop-item.locked { opacity: 0.6; filter: grayscale(0.8); }
        .shop-icon { font-size: 3rem; margin-bottom: 5px; }
        .shop-price { font-weight: bold; color: var(--gold); }
        
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>Ø­Ø§Ø±Ø³ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</h1>
        
        <div class="credits-box">
            <div class="credits-name">ÙÙƒØ±Ø© ÙˆØªØµÙ…ÙŠÙ…: Ø£. Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</div>
            <div class="social-icons">
                <a href="https://wa.me/966566996166" target="_blank"><i class="fab fa-whatsapp"></i></a>
                <a href="https://snapchat.com/t/2tVDWcXq" target="_blank"><i class="fab fa-snapchat"></i></a>
            </div>
        </div>

        <p style="margin-bottom: 15px; font-size: 1.1rem;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</p>
        <div class="mode-select">
            <button id="mode-lower" class="btn btn-blue mode-btn active" onclick="setMode('lower')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</button>
            <button id="mode-upper" class="btn btn-blue mode-btn" onclick="setMode('upper')">Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ù„ÙŠØ§</button>
        </div>

        <button class="btn" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ!</button>
        <button class="btn btn-gold" onclick="showShop()">Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø´Ø®ØµÙŠØ§Øª ğŸ›’</button>
    </div>

    <div id="shop-screen" class="screen hidden">
        <h1>Ù…ØªØ¬Ø± Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h1>
        <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span class="arabic-num" id="shop-coins-disp" style="color:var(--gold); font-size: 1.5rem;">Ù </span> ğŸ’°</p>
        <div class="shop-grid" id="shop-items-container">
            </div>
        <button class="btn btn-blue" onclick="closeShop()">Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: var(--accent-wrong); font-size: 3rem;">Ø³Ù‚Ø·Øª Ø§Ù„Ù‚Ù„Ø¹Ø©!</h1>
        <p style="font-size: 1.5rem;">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span class="arabic-num" id="final-score">Ù </span></p>
        <button class="btn" onclick="resetGame()">Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        <button class="btn btn-blue" onclick="location.reload()">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div id="game-container" class="hidden">
        <div id="game-view">
            <canvas id="game-canvas"></canvas>
            <div id="hud">
                <div class="hud-item"><i class="fas fa-heart" style="color:#e74c3c"></i> <span class="arabic-num" id="lives-disp">Ù£</span></div>
                <div class="hud-item"><i class="fas fa-star" style="color:var(--gold)"></i> <span class="arabic-num" id="score-disp">Ù </span></div>
                <div class="hud-item"><i class="fas fa-coins" style="color:gold"></i> <span class="arabic-num" id="coins-disp">Ù </span></div>
            </div>
        </div>

        <div id="controls-area">
            <div id="question-box">
                <div id="q-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div id="q-visual"></div>
            </div>
            <div id="options-grid">
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
                <button class="option-btn arabic-num" onclick="checkAnswer(this)"></button>
            </div>
        </div>
    </div>

    <script>
        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let gameMode = 'lower';
        let score = 0, lives = 3, coins = 0;
        let currentAnswer = 0;
        let gameState = 'start'; // start, playing, gameover
        let difficulty = 1;
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        let savedData = JSON.parse(localStorage.getItem('mathHeroData_v2')) || {
            coins: 0,
            boughtSkins: ['ğŸ‘®â€â™‚ï¸'],
            currentSkin: 'ğŸ‘®â€â™‚ï¸'
        };
        coins = savedData.coins;

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±
        const shopItems = [
            { icon: 'ğŸ‘®â€â™‚ï¸', price: 0 }, { icon: 'ğŸ¦¸â€â™‚ï¸', price: 50 },
            { icon: 'ğŸ¥·', price: 100 }, { icon: 'ğŸ¦', price: 200 },
            { icon: 'ğŸ¤–', price: 350 }, { icon: 'ğŸ‘‘', price: 500 }
        ];

        // ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let hero = { x: 50, y: 0, sprite: savedData.currentSkin };
        let enemies = [];
        let particles = [];
        let lastSpawnTime = 0;
        let spawnInterval = 2500;

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (Helpers) ---
        // Ø¯Ø§Ù„Ø© Ø³Ø­Ø±ÙŠØ© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ù„Ù‰ Ø¹Ø±Ø¨ÙŠØ© Ù…Ø´Ø±Ù‚ÙŠØ©
        function toArabicNum(num) {
            const map = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            return num.toString().split('').map(d => map[d] || d).join('');
        }
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„ Ù…Ù† Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        function fromArabicNum(str) {
             const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
             return parseInt(str.split('').map(d => map[d] || d).join(''));
        }

        function resizeCanvas() {
            const container = document.getElementById('game-view');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø·Ù„ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
            hero.y = canvas.height * 0.75; // Ø¹Ù„Ù‰ Ø®Ø· Ø§Ù„Ø£Ø±Ø¶
        }
        window.addEventListener('resize', resizeCanvas);

        // --- Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        function updateHUD() {
            document.querySelectorAll('.arabic-num').forEach(el => {
                if(el.id === 'score-disp') el.innerText = toArabicNum(score);
                if(el.id === 'lives-disp') el.innerText = toArabicNum(lives);
                if(el.id === 'coins-disp' || el.id === 'shop-coins-disp') el.innerText = toArabicNum(coins);
                if(el.id === 'final-score') el.innerText = toArabicNum(score);
            });
            saveProgress();
        }

        function setMode(mode) {
            gameMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('mode-'+mode).classList.add('active');
        }

        function saveProgress() {
            savedData.coins = coins;
            localStorage.setItem('mathHeroData_v2', JSON.stringify(savedData));
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© ---
        function startGame() {
            gameState = 'playing';
            score = 0; lives = 3; difficulty = 1; spawnInterval = 2500;
            enemies = []; particles = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            resizeCanvas();
            updateHUD();
            generateNewQuestion();
            gameLoop();
        }

        function generateNewQuestion() {
            let n1, n2, op, opSymbol, visualHTML = '';
            
            if (gameMode === 'lower') {
                // ØµÙÙˆÙ Ø£ÙˆÙ„ÙŠØ©: Ø¬Ù…Ø¹ ÙˆØ·Ø±Ø­ (0-10)
                op = Math.random() > 0.5 ? '+' : '-';
                opSymbol = op === '+' ? '+' : 'âˆ’'; // Ø¹Ù„Ø§Ù…Ø© Ø·Ø±Ø­ ÙˆØ§Ø¶Ø­Ø©
                if (op === '+') {
                    n1 = Math.floor(Math.random() * 11);
                    n2 = Math.floor(Math.random() * (11 - n1));
                    currentAnswer = n1 + n2;
                    visualHTML = drawVisualDots(n1) + ' + ' + drawVisualDots(n2);
                } else {
                    n1 = Math.floor(Math.random() * 11);
                    n2 = Math.floor(Math.random() * (n1 + 1));
                    currentAnswer = n1 - n2;
                    visualHTML = drawVisualDots(n1); // ÙÙŠ Ø§Ù„Ø·Ø±Ø­ Ù†Ù…Ø«Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·
                }
            } else {
                // ØµÙÙˆÙ Ø¹Ù„ÙŠØ§: Ø¶Ø±Ø¨ ÙˆÙ‚Ø³Ù…Ø©
                op = Math.random() > 0.5 ? '*' : '/';
                opSymbol = op === '*' ? 'Ã—' : 'Ã·';
                if (op === '*') {
                    n1 = Math.floor(Math.random() * 11);
                    n2 = Math.floor(Math.random() * 11);
                    currentAnswer = n1 * n2;
                } else {
                    n2 = Math.floor(Math.random() * 9) + 1; // Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ 1-9
                    currentAnswer = Math.floor(Math.random() * 11); // Ø§Ù„Ù†Ø§ØªØ¬ 0-10
                    n1 = n2 * currentAnswer; // Ø§Ù„Ù…Ù‚Ø³ÙˆÙ…
                }
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            document.getElementById('q-text').innerText = `${toArabicNum(n1)} ${opSymbol} ${toArabicNum(n2)} = ØŸ`;
            document.getElementById('q-visual').innerHTML = visualHTML;
            
            generateOptions(currentAnswer);
        }

        function drawVisualDots(num) {
            if(num === 0 || gameMode === 'upper') return '';
            let dots = '';
            for(let i=0; i<num; i++) dots += '<span class="dot"></span>';
            return `<div class="visual-representation">${dots}</div>`;
        }

        function generateOptions(correctAnswer) {
            let options = [correctAnswer];
            // ØªÙˆÙ„ÙŠØ¯ Ø®ÙŠØ§Ø±ÙŠÙ† Ø®Ø§Ø·Ø¦ÙŠÙ† Ù‚Ø±ÙŠØ¨ÙŠÙ† Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            while (options.length < 3) {
                let offset = Math.floor(Math.random() * 5) + 1; // Ø¥Ø²Ø§Ø­Ø© Ø¨ÙŠÙ† 1 Ùˆ 5
                let sign = Math.random() > 0.5 ? 1 : -1;
                let wrong = correctAnswer + (offset * sign);
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ø·Ø¦ Ù…Ù†Ø·Ù‚ÙŠ (ØºÙŠØ± Ø³Ø§Ù„Ø¨ØŒ ÙˆÙ„ÙŠØ³ Ù…ÙƒØ±Ø±)
                if (wrong >= 0 && !options.includes(wrong)) {
                    options.push(wrong);
                }
            }
            // Ø®Ù„Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            options.sort(() => Math.random() - 0.5);
            
            // ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø¹Ø±Ø¨ÙŠ
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach((btn, index) => {
                btn.innerText = toArabicNum(options[index]);
                btn.disabled = false; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
                btn.style.backgroundColor = 'white'; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
                btn.style.color = 'var(--primary)';
            });
        }

        function checkAnswer(btnElement) {
            const selectedAnswer = fromArabicNum(btnElement.innerText);
            const optionsBtns = document.querySelectorAll('.option-btn');
            optionsBtns.forEach(b => b.disabled = true); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø¤Ù‚ØªØ§Ù‹

            if (selectedAnswer === currentAnswer) {
                // Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
                btnElement.style.backgroundColor = 'var(--accent-correct)';
                btnElement.style.color = 'white';
                handleCorrect();
            } else {
                // Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©
                btnElement.style.backgroundColor = 'var(--accent-wrong)';
                btnElement.style.color = 'white';
                document.getElementById('controls-area').classList.add('shake');
                setTimeout(() => {
                     document.getElementById('controls-area').classList.remove('shake');
                     optionsBtns.forEach(b => {
                         b.disabled = false;
                         b.style.backgroundColor = 'white';
                         b.style.color = 'var(--primary)';
                     });
                }, 500);
            }
        }

        function handleCorrect() {
            score += 10;
            coins += 2;
            updateHUD();
            
            // ØªØ¯Ù…ÙŠØ± Ø£Ù‚Ø±Ø¨ ÙˆØ­Ø´
            if(enemies.length > 0) {
                createExplosion(enemies[0].x, enemies[0].y);
                enemies.shift();
            }

            // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø© ÙƒÙ„ 50 Ù†Ù‚Ø·Ø©
            if(score > 0 && score % 50 === 0) {
                difficulty += 0.2;
                spawnInterval = Math.max(1000, spawnInterval - 200);
            }

            setTimeout(generateNewQuestion, 300); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        }

        // --- Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ ÙˆØ§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§Øª (Canvas Loop) ---
        function gameLoop(timestamp) {
            if (gameState !== 'playing') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Ø±Ø³Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø£Ø±Ø¶
            drawEnvironment();

            // Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ù„
            ctx.font = `${canvas.height * 0.15}px Cairo`;
            ctx.textAlign = 'center';
            ctx.fillText(hero.sprite, canvas.width * 0.15, hero.y);

            // Ø¥Ø¶Ø§ÙØ© ÙˆØ­ÙˆØ´ Ø¬Ø¯ÙŠØ¯Ø©
            if (timestamp - lastSpawnTime > spawnInterval) {
                spawnEnemy();
                lastSpawnTime = timestamp;
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ±Ø³Ù… Ø§Ù„ÙˆØ­ÙˆØ´
            updateEnemies();

            // ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±
            updateParticles();

            requestAnimationFrame(gameLoop);
        }

        function drawEnvironment() {
            // Ø®Ø· Ø§Ù„Ø£Ø±Ø¶ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø©
            const groundLevel = canvas.height * 0.7; 
            // Ø±Ø³Ù… Ø§Ù„Ù‚Ù„Ø¹Ø© (Ø¨Ø³ÙŠØ·)
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(0, groundLevel - canvas.height*0.2, canvas.width*0.25, canvas.height*0.3);
             // Ø±Ø³Ù… Ø§Ù„Ø¨Ø§Ø¨
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(canvas.width*0.05, groundLevel - canvas.height*0.1, canvas.width*0.15, canvas.height*0.1);
        }

        function spawnEnemy() {
            const sprites = ['ğŸ‘¾', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ', 'ğŸ¦‚'];
            enemies.push({
                x: canvas.width + 50,
                y: canvas.height * 0.75, // Ø¹Ù„Ù‰ Ø®Ø· Ø§Ù„Ø£Ø±Ø¶
                speed: (canvas.width * 0.002) * difficulty, // Ø§Ù„Ø³Ø±Ø¹Ø© Ù†Ø³Ø¨ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©
                sprite: sprites[Math.floor(Math.random() * sprites.length)]
            });
        }

        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                e.x -= e.speed;
                
                // Ø±Ø³Ù… Ø§Ù„ÙˆØ­Ø´
                ctx.font = `${canvas.height * 0.12}px Cairo`;
                ctx.fillText(e.sprite, e.x, e.y);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ù‚Ù„Ø¹Ø©
                if (e.x < canvas.width * 0.2) {
                    enemies.splice(i, 1);
                    lives--;
                    updateHUD();
                    document.getElementById('game-view').classList.add('shake');
                    setTimeout(()=>document.getElementById('game-view').classList.remove('shake'), 400);
                    if(lives <= 0) gameOver();
                }
            }
        }

        function createExplosion(x, y) {
            for(let i=0; i<20; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5) * 10, vy: (Math.random()-0.5) * 10,
                    life: 1, color: `hsl(${Math.random()*360}, 100%, 50%)`
                });
            }
        }

        function updateParticles() {
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
                if(p.life<=0) particles.splice(i,1);
            }
            ctx.globalAlpha = 1;
        }

        function gameOver() {
            gameState = 'gameover';
            saveProgress();
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');
            updateHUD();
        }

        function resetGame() {
            document.getElementById('game-over-screen').classList.add('hidden');
            startGame();
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ¬Ø± ---
        function showShop() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('shop-screen').classList.remove('hidden');
            updateHUD();
            renderShopItems();
        }
        function closeShop() {
            document.getElementById('shop-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }
        function renderShopItems() {
            const container = document.getElementById('shop-items-container');
            container.innerHTML = '';
            shopItems.forEach(item => {
                const isBought = savedData.boughtSkins.includes(item.icon);
                const isSelected = savedData.currentSkin === item.icon;
                
                let div = document.createElement('div');
                div.className = `shop-item ${isSelected ? 'selected' : ''} ${!isBought ? 'locked' : ''}`;
                div.innerHTML = `
                    <div class="shop-icon">${item.icon}</div>
                    <div class="shop-price arabic-num">${isBought ? (isSelected ? 'Ù…Ø³ØªØ®Ø¯Ù…' : 'Ù…Ù…Ù„ÙˆÙƒ') : toArabicNum(item.price) + ' ğŸ’°'}</div>
                `;
                
                div.onclick = () => {
                    if (isBought) {
                        savedData.currentSkin = item.icon;
                        hero.sprite = item.icon;
                        saveProgress(); renderShopItems();
                    } else if (coins >= item.price) {
                        coins -= item.price;
                        savedData.boughtSkins.push(item.icon);
                        savedData.currentSkin = item.icon;
                        hero.sprite = item.icon;
                        saveProgress(); renderShopItems(); updateHUD();
                    }
                };
                container.appendChild(div);
            });
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        resizeCanvas();
    </script>
</body>
</html>
